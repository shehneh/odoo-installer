<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ›¡ï¸ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù„Ø§ÛŒØ³Ù†Ø³ - OdooMaster</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/liara-theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    // Keep admin panel theme in sync with the rest of the website (works inside iframe)
    (function () {
      function applyThemeFromStorage() {
        const isLight = localStorage.getItem('theme') === 'light';
        document.documentElement.classList.toggle('light-theme', isLight);
        if (document.body) document.body.classList.toggle('light-theme', isLight);
      }

      // Apply ASAP
      try { applyThemeFromStorage(); } catch (_) {}

      window.addEventListener('storage', (e) => {
        if (e && e.key === 'theme') {
          try { applyThemeFromStorage(); } catch (_) {}
        }
      });

      document.addEventListener('DOMContentLoaded', () => {
        try { applyThemeFromStorage(); } catch (_) {}
      });
    })();
  </script>
  <style>
    :root {
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: var(--dark);
      color: var(--white);
      min-height: 100vh;
    }

    body.light-theme {
      background: linear-gradient(135deg, #f0f2f5 0%, #e2e8f0 100%);
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-brand h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-user .user-name {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn-logout {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: rgba(255,255,255,0.25);
    }

    /* Dark theme (default) overrides for readability */
    body:not(.light-theme) .stat-card,
    body:not(.light-theme) .tab-btn,
    body:not(.light-theme) .card,
    body:not(.light-theme) .license-key-box {
      background: var(--dark-light);
      color: var(--white);
      box-shadow: var(--shadow-sm);
    }

    body:not(.light-theme) .tab-btn {
      color: var(--gray-light);
    }

    body:not(.light-theme) .tab-btn:hover:not(.active) {
      background: var(--dark-medium);
    }

    body:not(.light-theme) .card-header {
      border-bottom-color: var(--dark-medium);
    }

    body:not(.light-theme) .form-group label {
      color: var(--gray-light);
    }

    body:not(.light-theme) .form-group input,
    body:not(.light-theme) .form-group select,
    body:not(.light-theme) .form-group textarea {
      background: var(--dark-medium);
      border-color: var(--dark-medium);
      color: var(--white);
    }

    body:not(.light-theme) .form-group input:focus,
    body:not(.light-theme) .form-group select:focus,
    body:not(.light-theme) .form-group textarea:focus {
      background: var(--dark-light);
      box-shadow: 0 0 0 4px rgba(113, 75, 103, 0.25);
    }

    body:not(.light-theme) th,
    body:not(.light-theme) td {
      border-bottom-color: var(--dark-medium);
    }

    body:not(.light-theme) th {
      background: var(--dark-medium);
      color: var(--white);
    }

    body:not(.light-theme) td {
      color: var(--white);
    }

    body:not(.light-theme) tr:hover td {
      background: rgba(255, 255, 255, 0.04);
    }

    /* Main */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
    }

    .stat-card .icon {
      font-size: 36px;
    }

    .stat-card .info .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-card .info .label {
      font-size: 13px;
      color: var(--gray-light);
      margin-top: 4px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: white;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-light);
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .tab-btn.active {
      background: var(--accent);
      color: white;
    }

    .tab-btn:hover:not(.active) {
      background: #f8fafc;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Card */
    .card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f0f2f5;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-header h2 {
      font-size: 18px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
      background: #fafafa;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: white;
      box-shadow: 0 0 0 4px rgba(15, 52, 96, 0.1);
    }

    /* Validity Presets */
    .validity-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .preset-btn {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
    }

    .preset-btn:hover {
      border-color: var(--accent);
      background: #f8fafc;
    }

    .preset-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(15, 52, 96, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
    }

    .btn-secondary {
      background: #f0f2f5;
      color: #374151;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* License Output */
    .license-output {
      display: none;
      margin-top: 20px;
      padding: 24px;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-radius: 12px;
      border: 2px solid var(--success);
    }

    .license-output.show {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    .license-output h3 {
      color: #059669;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .license-key-box {
      background: white;
      border: 2px dashed var(--success);
      border-radius: 10px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
      margin-bottom: 16px;
    }

    .license-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
      margin-top: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      padding: 14px 16px;
      text-align: right;
      border-bottom: 1px solid #f0f2f5;
      font-size: 13px;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
    }

    tr:hover td {
      background: #fafbfc;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #d1fae5;
      color: #059669;
    }

    .badge-danger {
      background: #fee2e2;
      color: #dc2626;
    }

    .badge-warning {
      background: #fef3c7;
      color: #d97706;
    }

    .badge-info {
      background: #dbeafe;
      color: #2563eb;
    }

    /* Action Buttons in Table */
    .action-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      margin: 0 2px;
    }

    .action-btn.copy {
      background: #dbeafe;
      color: #2563eb;
    }

    .action-btn.download {
      background: #d1fae5;
      color: #059669;
    }

    .action-btn.revoke {
      background: #fee2e2;
      color: #dc2626;
    }

    .action-btn:hover {
      transform: scale(1.05);
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 80px;
      left: 20px;
      z-index: 1000;
    }

    .toast {
      background: var(--primary);
      color: white;
      padding: 14px 20px;
      border-radius: 10px;
      margin-bottom: 10px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Search */
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-box input {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray-light);
    }

    .loading i {
      font-size: 32px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Plans Grid */
    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
    }

    .plan-card {
      background: linear-gradient(135deg, var(--dark-medium) 0%, var(--dark-light) 100%);
      border-radius: 20px;
      padding: 28px;
      position: relative;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .plan-card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    }

    .plan-card.popular {
      border-color: var(--accent);
    }

    .plan-card.inactive {
      opacity: 0.6;
    }

    .plan-badge {
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .plan-card-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .plan-card-header h3 {
      font-size: 24px;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .plan-card-header .plan-id {
      font-size: 12px;
      color: var(--gray-light);
      font-family: monospace;
    }

    .plan-price {
      text-align: center;
      margin-bottom: 20px;
    }

    .plan-price .amount {
      font-size: 32px;
      font-weight: 800;
      color: var(--white);
    }

    .plan-price .currency {
      font-size: 14px;
      color: var(--gray-light);
    }

    .plan-price .duration {
      display: block;
      font-size: 13px;
      color: var(--gray-light);
      margin-top: 4px;
    }

    .plan-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .plan-detail {
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: 12px;
      text-align: center;
    }

    .plan-detail .value {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .plan-detail .label {
      font-size: 11px;
      color: var(--gray-light);
    }

    .plan-features {
      margin-bottom: 20px;
    }

    .plan-features li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
      color: var(--gray-light);
    }

    .plan-features li i {
      color: var(--success);
      font-size: 12px;
    }

    .plan-actions {
      display: flex;
      gap: 8px;
    }

    .plan-actions .btn {
      flex: 1;
      padding: 12px;
      font-size: 13px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal {
      background: var(--dark-light);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .modal-header h3 {
      font-size: 18px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--gray-light);
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--danger);
    }

    .modal-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-body small {
      display: block;
      color: var(--gray-light);
      font-size: 11px;
      margin-top: 4px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid rgba(255,255,255,0.1);
      justify-content: flex-end;
    }

    .checkbox-group {
      display: flex;
      gap: 20px;
      align-items: center;
      padding-top: 28px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .checkbox-label input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .card {
        padding: 20px;
      }

      .plans-grid {
        grid-template-columns: 1fr;
      }

      .modal {
        max-width: 100%;
        margin: 10px;
      }
    }
  </style>
</head>
<body class="liara-theme">
  <!-- Header -->
  <header class="header">
    <div class="header-brand">
      <span style="font-size: 24px;">ğŸ›¡ï¸</span>
      <h1>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù„Ø§ÛŒØ³Ù†Ø³</h1>
    </div>
    <div class="header-user">
      <span class="user-name" id="admin-name">Ù…Ø¯ÛŒØ±</span>
    </div>
  </header>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Main Content -->
  <main class="main">
    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="icon">ğŸ‘¥</div>
        <div class="info">
          <div class="value" id="stat-users">-</div>
          <div class="label">Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ”‘</div>
        <div class="info">
          <div class="value" id="stat-licenses">-</div>
          <div class="label">Ú©Ù„ Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon">âœ…</div>
        <div class="info">
          <div class="value" id="stat-active">-</div>
          <div class="label">Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸš«</div>
        <div class="info">
          <div class="value" id="stat-revoked">-</div>
          <div class="label">Ù„ØºÙˆ Ø´Ø¯Ù‡</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ’°</div>
        <div class="info">
          <div class="value" id="stat-revenue">-</div>
          <div class="label">Ø¯Ø±Ø¢Ù…Ø¯ (ØªÙˆÙ…Ø§Ù†)</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="licenses">ğŸ”‘ Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§</button>
      <button class="tab-btn" data-tab="users">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
      <button class="tab-btn" data-tab="plans">ğŸ’ Ù¾Ù„Ù†â€ŒÙ‡Ø§</button>
      <button class="tab-btn" data-tab="create">â• ØªÙˆÙ„ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³ Ø¬Ø¯ÛŒØ¯</button>
    </div>

    <!-- Tab: Licenses -->
    <div class="tab-content active" id="tab-licenses">
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-key"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§</h2>
        </div>
        
        <div class="search-box">
          <input type="text" id="license-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ù„ÛŒØ¯ØŒ Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ù†Ø§Ù…...">
          <button class="btn btn-secondary" onclick="loadLicenses()">
            <i class="fas fa-sync"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
          </button>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Hardware ID</th>
                <th>Ù…Ø´ØªØ±ÛŒ</th>
                <th>Ø§Ø¹ØªØ¨Ø§Ø±</th>
                <th>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯</th>
                <th>ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</th>
                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="licenses-table">
              <tr><td colspan="8" class="loading"><i class="fas fa-spinner"></i></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Users -->
    <div class="tab-content" id="tab-users">
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-users"></i> Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù†</h2>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Ù†Ø§Ù…</th>
                <th>Ø§ÛŒÙ…ÛŒÙ„</th>
                <th>Ù…ÙˆØ¨Ø§ÛŒÙ„</th>
                <th>Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§</th>
                <th>Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡Ø§</th>
                <th>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="users-table">
              <tr><td colspan="8" class="loading"><i class="fas fa-spinner"></i></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Plans -->
    <div class="tab-content" id="tab-plans">
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-gem"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§</h2>
          <button class="btn btn-primary" onclick="showAddPlanModal()">
            <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù† Ø¬Ø¯ÛŒØ¯
          </button>
        </div>
        
        <div id="plans-grid" class="plans-grid">
          <div class="loading"><i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>
      </div>
    </div>

    <!-- Tab: Create License -->
    <div class="tab-content" id="tab-create">
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-plus-circle"></i> ØªÙˆÙ„ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³ Ø¬Ø¯ÛŒØ¯</h2>
        </div>
        
        <form id="create-license-form">
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-microchip"></i> Ø´Ù†Ø§Ø³Ù‡ Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø±ÛŒ (Hardware ID)</label>
              <input type="text" id="new-hardware-id" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
              <small style="color: #9ca3af;">Ø§ÛŒÙ† Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ Ø§Ø² Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯</small>
            </div>
            <div class="form-group">
              <label><i class="fas fa-user"></i> Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
              <input type="text" id="new-customer-name" placeholder="Ù†Ø§Ù… Ø´Ø±Ú©Øª ÛŒØ§ Ø´Ø®Øµ">
            </div>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-clock"></i> Ù…Ø¯Øª Ø§Ø¹ØªØ¨Ø§Ø±</label>
            <div class="validity-presets">
              <button type="button" class="preset-btn" data-days="1">1 Ø³Ø§Ø¹Øª</button>
              <button type="button" class="preset-btn" data-days="3">3 Ø±ÙˆØ²</button>
              <button type="button" class="preset-btn" data-days="7">1 Ù‡ÙØªÙ‡</button>
              <button type="button" class="preset-btn" data-days="30">1 Ù…Ø§Ù‡</button>
              <button type="button" class="preset-btn" data-days="90">3 Ù…Ø§Ù‡</button>
              <button type="button" class="preset-btn active" data-days="180">6 Ù…Ø§Ù‡</button>
              <button type="button" class="preset-btn" data-days="365">1 Ø³Ø§Ù„</button>
              <button type="button" class="preset-btn" data-days="730">2 Ø³Ø§Ù„</button>
              <button type="button" class="preset-btn" data-days="0">Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯</button>
              <button type="button" class="preset-btn" data-days="custom">Ø³ÙØ§Ø±Ø´ÛŒ</button>
            </div>
            <input type="number" id="new-validity-days" value="180" min="1" style="max-width: 200px;">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-tag"></i> Ù¾Ù„Ù†</label>
              <select id="new-plan">
                <option value="trial">Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ (Trial)</option>
                <option value="starter" selected>Ø§Ø³ØªØ§Ø±ØªØ± (Starter)</option>
                <option value="professional">Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Professional)</option>
                <option value="enterprise">Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ (Enterprise)</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-sticky-note"></i> ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <textarea id="new-notes" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ..."></textarea>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-key"></i> ØªÙˆÙ„ÛŒØ¯ Ú©Ù„ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³
          </button>
        </form>
        
        <!-- License Output -->
        <div class="license-output" id="license-output">
          <h3><i class="fas fa-check-circle"></i> Ù„Ø§ÛŒØ³Ù†Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯!</h3>
          <div class="license-key-box" id="generated-license-key"></div>
          <div class="license-actions">
            <button class="btn btn-success" onclick="copyLicenseKey()">
              <i class="fas fa-copy"></i> Ú©Ù¾ÛŒ Ú©Ù„ÛŒØ¯
            </button>
            <button class="btn btn-primary" onclick="downloadLicenseFile()">
              <i class="fas fa-download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ license.oml
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Plan Modal -->
  <div class="modal-overlay" id="plan-modal" style="display: none;">
    <div class="modal plan-modal">
      <div class="modal-header">
        <h3 id="plan-modal-title"><i class="fas fa-gem"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù† Ø¬Ø¯ÛŒØ¯</h3>
        <button class="modal-close" onclick="closePlanModal()">&times;</button>
      </div>
      <form id="plan-form" onsubmit="savePlan(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-fingerprint"></i> Ø´Ù†Ø§Ø³Ù‡ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)</label>
              <input type="text" id="plan-id" placeholder="Ù…Ø«Ø§Ù„: hourly" pattern="[a-z0-9_-]+" required>
              <small>ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ú©ÙˆÚ†Ú©ØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø®Ø· ØªÛŒØ±Ù‡</small>
            </div>
            <div class="form-group">
              <label><i class="fas fa-sort-numeric-up"></i> ØªØ±ØªÛŒØ¨ Ù†Ù…Ø§ÛŒØ´</label>
              <input type="number" id="plan-sort" value="1" min="1">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-tag"></i> Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ</label>
              <input type="text" id="plan-name" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø¹ØªÛŒ" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-tag"></i> Ù†Ø§Ù… Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</label>
              <input type="text" id="plan-name-en" placeholder="Example: Hourly">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-money-bill"></i> Ù‚ÛŒÙ…Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†)</label>
              <input type="number" id="plan-price" value="0" min="0" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-money-bill-wave"></i> Ù‚ÛŒÙ…Øª Ø³Ø§Ù„Ø§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†)</label>
              <input type="number" id="plan-price-yearly" value="0" min="0">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-clock"></i> Ù…Ø¯Øª Ø§Ø¹ØªØ¨Ø§Ø±</label>
              <div style="display: flex; gap: 10px;">
                <input type="number" id="plan-duration-value" value="30" min="1" required style="flex: 1;">
                <select id="plan-duration-unit" style="width: 120px;">
                  <option value="hours">Ø³Ø§Ø¹Øª</option>
                  <option value="days" selected>Ø±ÙˆØ²</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-desktop"></i> Ø­Ø¯Ø§Ú©Ø«Ø± Ù†ØµØ¨</label>
              <input type="number" id="plan-activations" value="1" min="1" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-headset"></i> Ø³Ø·Ø­ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</label>
              <select id="plan-support">
                <option value="none">Ø¨Ø¯ÙˆÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</option>
                <option value="email">Ø§ÛŒÙ…ÛŒÙ„ÛŒ</option>
                <option value="phone">ØªÙ„ÙÙ†ÛŒ</option>
                <option value="priority">Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¯Ø§Ø± (24/7)</option>
              </select>
            </div>
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="plan-popular">
                <span><i class="fas fa-fire"></i> Ù¾Ø±ÙØ±ÙˆØ´</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="plan-active" checked>
                <span><i class="fas fa-check-circle"></i> ÙØ¹Ø§Ù„</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-list"></i> ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ (ÙØ§Ø±Ø³ÛŒ - Ù‡Ø± Ø®Ø· ÛŒÚ© ÙˆÛŒÚ˜Ú¯ÛŒ)</label>
            <textarea id="plan-features" rows="4" placeholder="Ù†ØµØ¨ Ø±ÙˆÛŒ Û± Ø³ÛŒØ³ØªÙ…&#10;Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§ÛŒÙ…ÛŒÙ„ÛŒ&#10;Ø¢Ù¾Ø¯ÛŒØª Û¶ Ù…Ø§Ù‡Ù‡"></textarea>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-list"></i> ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ - Ù‡Ø± Ø®Ø· ÛŒÚ© ÙˆÛŒÚ˜Ú¯ÛŒ)</label>
            <textarea id="plan-features-en" rows="4" placeholder="Install on 1 system&#10;Email support&#10;6 months updates"></textarea>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePlanModal()">Ø§Ù†ØµØ±Ø§Ù</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ Ù¾Ù„Ù†
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    let currentLicenseFile = null;
    let currentLicenseKey = null;

    // Check admin access
    async function checkAdmin() {
      if (!API.isLoggedIn()) {
        window.location.href = 'login.html?redirect=admin.html';
        return false;
      }
      
      try {
        const res = await API.getMe();
        if (!res.user || !res.user.is_admin) {
          showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯', 'error');
          setTimeout(() => window.location.href = 'dashboard.html', 2000);
          return false;
        }
        document.getElementById('admin-name').textContent = res.user.name || res.user.email;
        return true;
      } catch (e) {
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª', 'error');
        setTimeout(() => window.location.href = 'login.html', 2000);
        return false;
      }
    }

    // Load stats
    async function loadStats() {
      try {
        const res = await API.request('/admin/stats');
        document.getElementById('stat-users').textContent = res.users || 0;
        document.getElementById('stat-licenses').textContent = res.total_licenses || 0;
        document.getElementById('stat-active').textContent = res.active_licenses || 0;
        document.getElementById('stat-revoked').textContent = res.revoked_licenses || 0;
        document.getElementById('stat-revenue').textContent = (res.total_revenue || 0).toLocaleString('fa-IR');
      } catch (e) {
        console.error('Stats error:', e);
      }
    }

    // Load licenses
    async function loadLicenses() {
      const tbody = document.getElementById('licenses-table');
      tbody.innerHTML = '<tr><td colspan="8" class="loading"><i class="fas fa-spinner"></i></td></tr>';
      
      try {
        const res = await API.request('/admin/licenses');
        const searchTerm = document.getElementById('license-search').value.toLowerCase();
        
        let licenses = res.licenses || [];
        if (searchTerm) {
          licenses = licenses.filter(l => 
            (l.key || '').toLowerCase().includes(searchTerm) ||
            (l.user_email || '').toLowerCase().includes(searchTerm) ||
            (l.user_name || '').toLowerCase().includes(searchTerm) ||
            (l.customer_name || '').toLowerCase().includes(searchTerm)
          );
        }
        
        if (licenses.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--gray-light);">Ù„Ø§ÛŒØ³Ù†Ø³ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
          return;
        }
        
        tbody.innerHTML = licenses.map((lic, i) => {
          const hwid = (lic.hardware_ids || [])[0] || '-';
          const statusBadge = lic.status === 'active' 
            ? '<span class="badge badge-success">ÙØ¹Ø§Ù„</span>'
            : '<span class="badge badge-danger">Ù„ØºÙˆ Ø´Ø¯Ù‡</span>';
          
          return `
            <tr>
              <td>${i + 1}</td>
              <td style="font-family: monospace; font-size: 11px;">${hwid}</td>
              <td>${lic.customer_name || lic.user_name || lic.user_email || '-'}</td>
              <td>${lic.plan_name || lic.plan || '-'}</td>
              <td>${formatDate(lic.created_at)}</td>
              <td>${formatDate(lic.expires_at)}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="action-btn copy" onclick="copyText('${lic.key}')" title="Ú©Ù¾ÛŒ Ú©Ù„ÛŒØ¯">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="action-btn download" onclick="downloadLicenseFor('${lic.key}')" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„">
                  <i class="fas fa-download"></i>
                </button>
                ${lic.status === 'active' ? `
                  <button class="action-btn revoke" onclick="revokeLicense('${lic.key}')" title="Ù„ØºÙˆ">
                    <i class="fas fa-ban"></i>
                  </button>
                ` : ''}
              </td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#ef4444;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</td></tr>';
      }
    }

    // Load users
    async function loadUsers() {
      const tbody = document.getElementById('users-table');
      tbody.innerHTML = '<tr><td colspan="8" class="loading"><i class="fas fa-spinner"></i></td></tr>';
      
      try {
        const res = await API.request('/admin/users');
        const users = res.users || [];
        
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--gray-light);">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
          return;
        }
        
        tbody.innerHTML = users.map((u, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${u.name || '-'} ${u.is_admin ? '<span class="badge badge-info">Ù…Ø¯ÛŒØ±</span>' : ''}</td>
            <td>${u.email}</td>
            <td>${u.phone || '-'}</td>
            <td>${u.license_count || 0}</td>
            <td>${u.downloads || 0}</td>
            <td>${formatDate(u.created_at)}</td>
            <td>
              ${u.is_admin
                ? `<button class="action-btn revoke" onclick="setUserAdmin('${u.email}', false)" title="Ø¹Ø²Ù„ Ù…Ø¯ÛŒØ±">
                     <i class="fas fa-user-slash"></i>
                   </button>`
                : `<button class="action-btn copy" onclick="setUserAdmin('${u.email}', true)" title="Ù…Ø¯ÛŒØ± Ú©Ø±Ø¯Ù†">
                     <i class="fas fa-user-shield"></i>
                   </button>`
              }
            </td>
          </tr>
        `).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#ef4444;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</td></tr>';
      }
    }

    async function setUserAdmin(email, isAdmin) {
      const actionText = isAdmin ? 'Ù…Ø¯ÛŒØ± Ú©Ø±Ø¯Ù†' : 'Ø¹Ø²Ù„ Ù…Ø¯ÛŒØ±';
      if (!confirm(`${actionText} Ø¨Ø±Ø§ÛŒ ${email} Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯ØŸ`)) return;

      try {
        const res = await API.request('/admin/users/admin-status', {
          method: 'PATCH',
          body: JSON.stringify({ email, is_admin: isAdmin })
        });

        if (res && res.success) {
          showToast('Ø«Ø¨Øª Ø´Ø¯', 'success');
          loadUsers();
          loadStats();
        } else {
          showToast(res.error || 'Ø®Ø·Ø§', 'error');
        }
      } catch (e) {
        showToast(e.message || 'Ø®Ø·Ø§', 'error');
      }
    }

    // Create license
    document.getElementById('create-license-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const hardwareId = document.getElementById('new-hardware-id').value.trim();
      const customerName = document.getElementById('new-customer-name').value.trim();
      const validityDays = parseInt(document.getElementById('new-validity-days').value) || 180;
      const plan = document.getElementById('new-plan').value;
      const notes = document.getElementById('new-notes').value.trim();
      
      try {
        const res = await API.request('/admin/licenses', {
          method: 'POST',
          body: JSON.stringify({
            hardware_id: hardwareId,
            customer_name: customerName,
            validity_days: validityDays,
            plan: plan,
            notes: notes,
          })
        });
        
        if (res.success && res.license) {
          currentLicenseKey = res.license.key;
          currentLicenseFile = res.license_file;
          
          document.getElementById('generated-license-key').textContent = res.license.key;
          document.getElementById('license-output').classList.add('show');
          
          showToast('Ù„Ø§ÛŒØ³Ù†Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯!', 'success');
          loadLicenses();
          loadStats();
        } else {
          showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³', 'error');
        }
      } catch (e) {
        showToast(e.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³', 'error');
      }
    });

    // Validity presets
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const days = btn.dataset.days;
        if (days === 'custom') {
          document.getElementById('new-validity-days').focus();
        } else if (days === '0') {
          document.getElementById('new-validity-days').value = 36500; // ~100 years
        } else {
          document.getElementById('new-validity-days').value = days;
        }
      });
    });

    // Copy license key
    function copyLicenseKey() {
      if (currentLicenseKey) {
        copyText(currentLicenseKey);
      }
    }

    // Download license file
    function downloadLicenseFile() {
      if (!currentLicenseFile) {
        showToast('ÙØ§ÛŒÙ„ Ù„Ø§ÛŒØ³Ù†Ø³ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª', 'error');
        return;
      }
      
      const blob = new Blob([JSON.stringify(currentLicenseFile, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'license.oml';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      
      showToast('ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
    }

    // Download license for existing key
    async function downloadLicenseFor(key) {
      const hwid = prompt('Ø´Ù†Ø§Ø³Ù‡ Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', '');
      if (hwid === null) return;
      
      try {
        const res = await API.request(`/admin/licenses/${encodeURIComponent(key)}/file`, {
          method: 'POST',
          body: JSON.stringify({ hardware_id: hwid.trim() })
        });
        
        if (res.success && res.license_file) {
          const blob = new Blob([JSON.stringify(res.license_file, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'license.oml';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);
          
          showToast('ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
        } else {
          showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„', 'error');
        }
      } catch (e) {
        showToast(e.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„', 'error');
      }
    }

    // Revoke license
    async function revokeLicense(key) {
      if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ù„ØºÙˆ Ø§ÛŒÙ† Ù„Ø§ÛŒØ³Ù†Ø³ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
      
      try {
        const res = await API.request(`/admin/licenses/${encodeURIComponent(key)}`, {
          method: 'DELETE'
        });
        
        if (res.success) {
          showToast('Ù„Ø§ÛŒØ³Ù†Ø³ Ù„ØºÙˆ Ø´Ø¯', 'success');
          loadLicenses();
          loadStats();
        } else {
          showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù„Ø§ÛŒØ³Ù†Ø³', 'error');
        }
      } catch (e) {
        showToast(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù„Ø§ÛŒØ³Ù†Ø³', 'error');
      }
    }

    // Copy text
    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Ú©Ù¾ÛŒ Ø´Ø¯!', 'success');
      }).catch(() => {
        showToast('Ú©Ù¾ÛŒ Ù†Ø´Ø¯', 'error');
      });
    }

    // Format date
    function formatDate(iso) {
      if (!iso) return '-';
      try {
        const d = new Date(iso);
        return d.toLocaleDateString('fa-IR');
      } catch {
        return iso;
      }
    }

    // Toast
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Logout
    function logout() {
      API.clearToken();
      window.location.href = 'login.html';
    }

    // ============================================
    // Plans Management
    // ============================================
    let editingPlanId = null;

    async function loadPlans() {
      const container = document.getElementById('plans-grid');
      container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';
      
      try {
        const res = await API.request('/admin/plans');
        const plans = res.plans || [];
        
        if (plans.length === 0) {
          container.innerHTML = '<div class="loading">Ù‡ÛŒÚ† Ù¾Ù„Ù†ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
          return;
        }
        
        container.innerHTML = plans.map(plan => renderPlanCard(plan)).join('');
      } catch (e) {
        container.innerHTML = '<div class="loading" style="color: var(--danger);">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ù„Ù†â€ŒÙ‡Ø§</div>';
        console.error('Load plans error:', e);
      }
    }

    function renderPlanCard(plan) {
      const features = (plan.features || []).slice(0, 5);
      const supportLabels = {
        'none': 'Ø¨Ø¯ÙˆÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ',
        'email': 'Ø§ÛŒÙ…ÛŒÙ„ÛŒ',
        'phone': 'ØªÙ„ÙÙ†ÛŒ',
        'priority': '24/7'
      };
      
      const durationInfo = getDurationInfo(plan);
      const durationLabel = getDurationLabel(plan);
      
      return `
        <div class="plan-card ${plan.popular ? 'popular' : ''} ${!plan.active ? 'inactive' : ''}">
          ${plan.popular ? '<div class="plan-badge"><i class="fas fa-fire"></i> Ù¾Ø±ÙØ±ÙˆØ´</div>' : ''}
          ${!plan.active ? '<div class="plan-badge" style="background: var(--danger);">ØºÛŒØ±ÙØ¹Ø§Ù„</div>' : ''}
          
          <div class="plan-card-header">
            <h3>${plan.name}</h3>
            <div class="plan-id">${plan.id}</div>
          </div>
          
          <div class="plan-price">
            <span class="amount">${plan.price.toLocaleString('fa-IR')}</span>
            <span class="currency">ØªÙˆÙ…Ø§Ù†</span>
            <span class="duration">${durationLabel}</span>
          </div>
          
          <div class="plan-details">
            <div class="plan-detail">
              <div class="value">${durationInfo.valueLabel}</div>
              <div class="label">${durationInfo.unitLabel}</div>
            </div>
            <div class="plan-detail">
              <div class="value">${plan.max_activations === 999 ? 'âˆ' : plan.max_activations}</div>
              <div class="label">Ù†ØµØ¨ Ù…Ø¬Ø§Ø²</div>
            </div>
            <div class="plan-detail">
              <div class="value">${supportLabels[plan.support_level] || plan.support_level}</div>
              <div class="label">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</div>
            </div>
            <div class="plan-detail">
              <div class="value">${plan.sort_order || 1}</div>
              <div class="label">ØªØ±ØªÛŒØ¨</div>
            </div>
          </div>
          
          <ul class="plan-features">
            ${features.map(f => `<li><i class="fas fa-check"></i> ${f}</li>`).join('')}
            ${plan.features.length > 5 ? `<li style="color: var(--accent);">+${plan.features.length - 5} ÙˆÛŒÚ˜Ú¯ÛŒ Ø¯ÛŒÚ¯Ø±...</li>` : ''}
          </ul>
          
          <div class="plan-actions">
            <button class="btn btn-primary" onclick="editPlan('${plan.id}')">
              <i class="fas fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´
            </button>
            <button class="btn btn-danger" onclick="deletePlan('${plan.id}', '${plan.name}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }

    function getDurationInfo(plan) {
      const unit = (plan && plan.duration_unit) ? String(plan.duration_unit) : 'days';
      const rawValue = (plan && plan.duration_value != null) ? plan.duration_value : plan?.duration_days;
      const value = Number(rawValue);

      if (!Number.isFinite(value)) {
        return { unit, value, unitLabel: 'Ø§Ø¹ØªØ¨Ø§Ø±', valueLabel: '-' };
      }
      if (value <= 0) {
        return { unit, value, unitLabel: 'Ø§Ø¹ØªØ¨Ø§Ø±', valueLabel: 'âˆ' };
      }

      if (unit === 'hours') {
        return { unit, value, unitLabel: 'Ø³Ø§Ø¹Øª Ø§Ø¹ØªØ¨Ø§Ø±', valueLabel: String(Math.trunc(value)) };
      }

      return { unit: 'days', value, unitLabel: 'Ø±ÙˆØ² Ø§Ø¹ØªØ¨Ø§Ø±', valueLabel: String(Math.trunc(value)) };
    }

    function getDurationLabel(plan) {
      const info = getDurationInfo(plan);
      if (info.value <= 0) return 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯';

      if (info.unit === 'hours') {
        return `${Math.trunc(info.value)} Ø³Ø§Ø¹ØªÙ‡`;
      }

      const days = Math.trunc(info.value);
      if (days === 1) return 'Û± Ø±ÙˆØ²Ù‡';
      if (days === 7) return 'Ù‡ÙØªÚ¯ÛŒ';
      if (days === 30) return 'Ù…Ø§Ù‡Ø§Ù†Ù‡';
      if (days === 90) return 'Û³ Ù…Ø§Ù‡Ù‡';
      if (days === 180) return 'Û¶ Ù…Ø§Ù‡Ù‡';
      if (days === 365) return 'Ø³Ø§Ù„Ø§Ù†Ù‡';
      if (days === 730) return 'Û² Ø³Ø§Ù„Ù‡';
      if (days >= 3650) return 'Ù…Ø§Ø¯Ø§Ù…â€ŒØ§Ù„Ø¹Ù…Ø±';
      return `${days} Ø±ÙˆØ²Ù‡`;
    }

    function showAddPlanModal() {
      editingPlanId = null;
      document.getElementById('plan-modal-title').innerHTML = '<i class="fas fa-plus-circle"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù† Ø¬Ø¯ÛŒØ¯';
      document.getElementById('plan-form').reset();
      document.getElementById('plan-id').disabled = false;
      document.getElementById('plan-active').checked = true;
      document.getElementById('plan-duration-unit').value = 'days';
      document.getElementById('plan-duration-value').value = 30;
      document.getElementById('plan-modal').style.display = 'flex';
    }

    async function editPlan(planId) {
      try {
        const res = await API.request('/admin/plans');
        const plan = (res.plans || []).find(p => p.id === planId);
        
        if (!plan) {
          showToast('Ù¾Ù„Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
          return;
        }
        
        editingPlanId = planId;
        document.getElementById('plan-modal-title').innerHTML = '<i class="fas fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ù„Ù†';
        
        document.getElementById('plan-id').value = plan.id;
        document.getElementById('plan-id').disabled = true;
        document.getElementById('plan-name').value = plan.name || '';
        document.getElementById('plan-name-en').value = plan.name_en || '';
        document.getElementById('plan-price').value = plan.price || 0;
        document.getElementById('plan-price-yearly').value = plan.price_yearly || 0;
        document.getElementById('plan-duration-unit').value = plan.duration_unit || 'days';
        document.getElementById('plan-duration-value').value = (plan.duration_value != null ? plan.duration_value : (plan.duration_days || 30));
        document.getElementById('plan-activations').value = plan.max_activations || 1;
        document.getElementById('plan-support').value = plan.support_level || 'email';
        document.getElementById('plan-popular').checked = plan.popular || false;
        document.getElementById('plan-active').checked = plan.active !== false;
        document.getElementById('plan-sort').value = plan.sort_order || 1;
        document.getElementById('plan-features').value = (plan.features || []).join('\n');
        document.getElementById('plan-features-en').value = (plan.features_en || []).join('\n');
        
        document.getElementById('plan-modal').style.display = 'flex';
      } catch (e) {
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ù„Ù†', 'error');
      }
    }

    function closePlanModal() {
      document.getElementById('plan-modal').style.display = 'none';
      editingPlanId = null;
    }

    async function savePlan(e) {
      e.preventDefault();
      
      const planData = {
        id: document.getElementById('plan-id').value.trim().toLowerCase(),
        name: document.getElementById('plan-name').value.trim(),
        name_en: document.getElementById('plan-name-en').value.trim(),
        price: parseInt(document.getElementById('plan-price').value) || 0,
        price_yearly: parseInt(document.getElementById('plan-price-yearly').value) || 0,
        duration_unit: document.getElementById('plan-duration-unit').value || 'days',
        duration_value: parseFloat(document.getElementById('plan-duration-value').value) || 30,
        max_activations: parseInt(document.getElementById('plan-activations').value) || 1,
        support_level: document.getElementById('plan-support').value,
        popular: document.getElementById('plan-popular').checked,
        active: document.getElementById('plan-active').checked,
        sort_order: parseInt(document.getElementById('plan-sort').value) || 1,
        features: document.getElementById('plan-features').value.split('\n').map(s => s.trim()).filter(Boolean),
        features_en: document.getElementById('plan-features-en').value.split('\n').map(s => s.trim()).filter(Boolean)
      };
      
      try {
        let res;
        if (editingPlanId) {
          res = await API.request(`/admin/plans/${editingPlanId}`, {
            method: 'PUT',
            body: JSON.stringify(planData)
          });
        } else {
          res = await API.request('/admin/plans', {
            method: 'POST',
            body: JSON.stringify(planData)
          });
        }
        
        if (res.success) {
          showToast(editingPlanId ? 'Ù¾Ù„Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ù¾Ù„Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
          closePlanModal();
          loadPlans();
        } else {
          showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ù„Ù†', 'error');
        }
      } catch (e) {
        showToast(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ù„Ù†', 'error');
      }
    }

    async function deletePlan(planId, planName) {
      if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù¾Ù„Ù† "${planName}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;
      
      try {
        const res = await API.request(`/admin/plans/${planId}`, {
          method: 'DELETE'
        });
        
        if (res.success) {
          showToast('Ù¾Ù„Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
          loadPlans();
        } else {
          showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾Ù„Ù†', 'error');
        }
      } catch (e) {
        showToast(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾Ù„Ù†', 'error');
      }
    }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        
        // Load data for tab
        if (btn.dataset.tab === 'users') loadUsers();
        if (btn.dataset.tab === 'plans') loadPlans();
      });
    });

    // Search
    document.getElementById('license-search').addEventListener('input', loadLicenses);

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePlanModal();
    });

    // Close modal on backdrop click
    document.getElementById('plan-modal').addEventListener('click', (e) => {
      if (e.target.id === 'plan-modal') closePlanModal();
    });

    // Init
    (async () => {
      if (await checkAdmin()) {
        loadStats();
        loadLicenses();
      }
    })();
  </script>
</body>
</html>
